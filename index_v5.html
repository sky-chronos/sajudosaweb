<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sky Chronos v4 — 이중기준(전통/천문) 사주·절기 계산기</title>
<style>
:root{--bg:#0b1020;--card:#101833;--fg:#e9ecf6;--mut:#9fb0ff;--ok:#6ee7b7;--bad:#fca5a5}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,AppleSDGothicNeo,NotoSansKR,sans-serif;padding:14px}
h1{font-size:1.2rem;margin:.2rem 0 .6rem}
.card{background:var(--card);border-radius:14px;padding:12px;margin-bottom:10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
label{font-size:.8rem;color:var(--mut)}
input,select,button{width:100%;padding:10px;border-radius:10px;border:0;background:#0f1530;color:var(--fg)}
button{background:#1b2a6b;font-weight:700}
.row{display:flex;gap:8px}
.small{font-size:.75rem;color:#b7c1ff}
.out{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.82rem}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#1c2350;margin-right:6px}
.good{background:#124d3a}
.warn{background:#5b3a12}
hr{border:0;border-top:1px solid #26307a;margin:10px 0}
</style>
</head>
<body>
<h1>Sky Chronos v4</h1>

<div class="card">
  <div class="grid">
    <div>
      <label>날짜</label>
      <input id="d" type="date" value="2023-03-19">
    </div>
    <div>
      <label>시간 (KST)</label>
      <input id="t" type="time" value="00:20">
    </div>
  </div>
  <div class="grid" style="margin-top:8px">
    <div>
      <label>일주 기준</label>
      <select id="dayRule">
        <option value="midnight0">0시 기준</option>
        <option value="midnight23">자정교자(23시)</option>
      </select>
    </div>
    <div>
      <label>지역시 보정</label>
      <select id="locMode">
        <option value="none">없음(표준시)</option>
        <option value="auto">경도 자동</option>
        <option value="manual">분 수동</option>
      </select>
    </div>
  </div>
  <div class="grid" style="margin-top:8px">
    <div>
      <label>경도(°E)</label>
      <input id="lon" type="number" step="0.1" value="126.98">
    </div>
    <div>
      <label>수동 보정(분)</label>
      <input id="man" type="number" step="1" value="0">
    </div>
  </div>
  <button style="margin-top:10px" onclick="calc()">NASA 기준 계산</button>
  <div class="small" style="margin-top:6px">※ 절기/월주는 태양황경(근사) 기반, 일·시는 전통/천문 이중기준 비교 출력</div>
</div>

<div class="card">
  <div id="quality"></div>
  <hr>
  <div class="row">
    <div class="card" style="flex:1">
      <div class="tag">전통 기준</div>
      <div id="trad" class="out"></div>
    </div>
    <div class="card" style="flex:1">
      <div class="tag">천문(태양) 기준</div>
      <div id="astro" class="out"></div>
    </div>
  </div>
</div>

<div class="card">
  <div class="out" id="log"></div>
</div>

<script>
// ===== 유틸 =====
const rad=Math.PI/180, mod=(a,b)=>((a%b)+b)%b;
function toUTCms(d,t){
  const [y,m,da]=d.split("-").map(Number);
  const [hh,mm]=t.split(":").map(Number);
  // KST -> UTC
  return Date.UTC(y,m-1,da,hh-9,mm,0);
}
function jdFromUTCms(ms){ return ms/86400000 + 2440587.5; }

// ===== 태양황경(근사) =====
// NOAA 근사식 (nutation/aberration 간단 포함)
function solarLon(jd){
  const T=(jd-2451545.0)/36525;
  const L0=mod(280.46646+36000.76983*T+0.0003032*T*T,360);
  const M=mod(357.52911+35999.05029*T-0.0001537*T*T,360);
  const C=(1.914602-0.004817*T-0.000014*T*T)*Math.sin(M*rad)
        +(0.019993-0.000101*T)*Math.sin(2*M*rad)
        +0.000289*Math.sin(3*M*rad);
  const trueLon=L0+C;
  const omega=125.04-1934.136*T;
  const lambda=trueLon-0.00569-0.00478*Math.sin(omega*rad);
  return mod(lambda,360);
}
const terms=["춘분","청명","곡우","입하","소만","망종","하지","소서","대서","입추","처서","백로",
             "추분","한로","상강","입동","소설","대설","동지","소한","대한","입춘","우수","경칩"];
function termIndex(lon){ return Math.floor(lon/15); }
function monthBranchFromTerm(idx){
  // 입춘=寅월 시작
  const map=[/*춘분*/"묘","묘","진","사","사","오","오","미","미","신","신","유",
             "유","술","술","해","해","자","자","축","축","인","인","묘"];
  return map[idx];
}
const stems="갑을병정무기경신임계".split("");
const branches="자축인묘진사오미신유술해".split("");

// ===== 60갑자 =====
function ganzhiFromIndex(i){ return stems[mod(i,10)] + branches[mod(i,12)]; }

// 전통 일진 기준일: 1900-01-31 = 갑자
const baseJD = 2415020.5; // 1900-01-31 00:00 UTC
function dayIndexFromJD(jd){ return Math.floor(jd - baseJD); }

// ===== 지역시 보정(분) =====
function localOffsetMinutes(){
  const mode=locMode.value;
  if(mode==="none") return 0;
  if(mode==="manual") return Number(man.value||0);
  // 자동: (경도-135)*4
  const L=Number(lon.value||135);
  return Math.round((L-135)*4);
}

// ===== 일주/시주 =====
function pillarsFromUTC(msUTC, use23, useLocal){
  let adj = useLocal ? localOffsetMinutes()*60000 : 0;
  let ms = msUTC + adj;
  let d = new Date(ms);
  let h=d.getUTCHours(), m=d.getUTCMinutes();
  let jd=jdFromUTCms(ms);
  // 자정교자
  if(use23 && (h*60+m)<23*60) jd-=1;
  const di=dayIndexFromJD(jd);
  const dayGZ=ganzhiFromIndex(di);
  const dayStem=stems[mod(di,10)];
  // 시지
  const hz = Math.floor(((h*60+m)+60)/120)%12; // 23시 시작
  const hourBranch=branches[hz];
  // 시천간: (일간*2 + 시지)
  const stemIndex=(stems.indexOf(dayStem)*2 + hz)%10;
  const hourGZ=stems[stemIndex]+hourBranch;
  return {dayGZ,hourGZ,adjMin:useLocal?localOffsetMinutes():0};
}

// ===== 연·월 =====
function yearPillarFromLon(jd){
  // 입춘(315°) 이후 새해
  const lon=solarLon(jd);
  let y=new Date((jd-2440587.5)*86400000).getUTCFullYear();
  if(lon<315) y-=1;
  const idx=y-1984; // 1984 갑자
  return ganzhiFromIndex(idx);
}
function monthPillar(jd){
  const lon=solarLon(jd), ti=termIndex(lon);
  const mb=monthBranchFromTerm(ti);
  // 월간: (연간*2 + 월지index)
  const yp=yearPillarFromLon(jd);
  const ystem=yp[0];
  const si=stems.indexOf(ystem), bi=branches.indexOf(mb);
  const mstem=stems[(si*2+bi)%10];
  return {mp:mstem+mb, ti, lon};
}

// ===== 메인 =====
function calc(){
  const msUTC=toUTCms(d.value,t.value);
  const jd=jdFromUTCms(msUTC);
  const {mp,ti,lon}=monthPillar(jd);
  const yp=yearPillarFromLon(jd);

  const trad=pillarsFromUTC(msUTC, dayRule.value==="midnight23", true);
  const astro=pillarsFromUTC(msUTC, false, false);

  // 경계 품질
  const frac=mod(lon,15);
  const min=Math.min(frac,15-frac)*4*60; // 대략 분
  const q = min>720 ? "HIGH" : (min>180?"MED":"LOW");

  quality.innerHTML = `<span class="tag ${q==="HIGH"?"good":"warn"}">경계 품질 ${q}</span>
  <span class="small">절기 ${terms[ti]} · 황경 ${lon.toFixed(3)}° · 경계까지 약 ${Math.round(min)}분</span>`;

  trad.innerText =
`연주 ${yp}
월주 ${mp}
일주 ${trad.dayGZ}
시주 ${trad.hourGZ}
지역시 보정 ${trad.adjMin}분`;

  astro.innerText =
`연주 ${yp}
월주 ${mp}
일주 ${astro.dayGZ}
시주 ${astro.hourGZ}
지역시 보정 없음`;

  log.innerText =
`[천문 로그]
UTC ${new Date(msUTC).toISOString().slice(0,16).replace("T"," ")}
태양황경 λ=${lon.toFixed(6)}°
절기=${terms[ti]} / 절기월=${monthBranchFromTerm(ti)}
계산모드: 전통(자정교자·지역시) vs 천문(태양일)
※ 전통 기준은 사회·달력 일치, 천문 기준은 태양 물리 위치 일치`;
}
calc();
</script>
</body>
</html>
